{% extends 'base.html' %}
{% block titulo %}Clientes{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Tabla principal (lado izquierdo) -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Lista de Clientes</h2>
                    <form method="GET" action="{% url 'clientes' %}" class="d-flex mt-3" role="search">
                        <input class="form-control me-2" type="search" placeholder="Buscar clientes..." 
                        name="search" aria-label="Search" value="">
                        <button class="btn btn-outline-primary" type="submit">Buscar</button>
                    </form>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>CURP</th>
                                    <th>NSS</th>
                                    <th>Tel</th>
                                    <th>Vendedor</th>
                                    {% if user.is_authenticated and user.userrole.role == 'gerente' or user.userrole.role == 'administrador' %}
                                        <th>Acciones</th>
                                    {% endif %}
                                    <th>Ver</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in clientes %}
                                    <tr>
                                        <td>{{ cliente.id }}</td>
                                        <td>{{ cliente.nombre }}</td>
                                        <td>{{ cliente.curp }}</td>
                                        <td>{{ cliente.nss }}</td>
                                        <td>{{ cliente.telefono }}</td>
                                        <td>{{ cliente.vendedor }}</td>
                                        {% if user.is_authenticated and user.userrole.role == 'gerente' or user.userrole.role == 'administrador' %}
                                            <td>
                                                <a class="btn btn-sm btn-info" href="{% url 'editar' cliente.id %}">Editar</a>
                                                <a class="btn btn-sm btn-danger" href="{% url 'eliminar' cliente.id %}">Eliminar</a>
                                            </td>   
                                        {% endif %}
                                        <td>
                                            <button type="button" class="btn btn-primary btn-mostrar" data-id="{{ cliente.id }}">
                                                Ver
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>   
                        
                        <!-- Paginación -->
                        <div class="pagination">
                            <span class="step-links">
                                {% if page_obj.has_previous %}
                                    <a href="?page=1">&laquo; primera</a>
                                    <a href="?page={{ page_obj.previous_page_number }}">anterior</a>
                                {% endif %}
                                <span class="current">
                                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
                                </span>
                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}">siguiente</a>
                                    <a href="?page={{ page_obj.paginator.num_pages }}">última &raquo;</a>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% if user.is_authenticated and user.userrole.role == 'gerente' or user.userrole.role == 'administrador' %}     
                        <div class="mt-3">
                            <a class="btn btn-success" href="{% url 'agregar' %}">Agregar un Cliente</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Información detallada (lado derecho) -->
        <div class="col-md-4">
            <div id="detalle-cliente" class="card sticky-top" style="top: 20px; display: none;">
                {% include 'clientes/informacion_cliente.html' %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const botonesMostrar = document.querySelectorAll('.btn-mostrar');
    const detalleCliente = document.getElementById('detalle-cliente');

    botonesMostrar.forEach(boton => {
        boton.addEventListener('click', function() {
            const clienteId = this.getAttribute('data-id');

            fetch(`/clientes/${clienteId}/informacion/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                detalleCliente.innerHTML = html;
                detalleCliente.style.display = 'block';
            })
            .catch(error => {
                console.error('Error al cargar la información:', error);
            });
        });
    });
});
</script>
{% endblock %}